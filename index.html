<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DocuQuiz Instant Feedback</title>
    <style>
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; color: #333; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.6; }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 30px; }
        
        /* ìƒë‹¨ ì ìˆ˜íŒ (Sticky) */
        .score-header { position: sticky; top: 0; background: white; z-index: 100; padding: 15px 20px; border-radius: 0 0 12px 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: none; justify-content: space-between; align-items: center; margin-bottom: 20px; border: 1px solid #e1e4e8; border-top: none; }
        .score-text { font-size: 1.2em; font-weight: bold; color: #2c3e50; }
        
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        /* ì…ë ¥ í¼ ìŠ¤íƒ€ì¼ */
        .form-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .form-group { margin-bottom: 15px; flex: 1; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #34495e; }
        input[type="text"], input[type="number"], select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        
        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        button { background-color: #3498db; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 600; transition: background 0.2s; width: 100%; }
        button:hover { background-color: #2980b9; }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        
        .check-btn { background-color: #27ae60; margin-top: 15px; }
        .check-btn:hover { background-color: #219150; }
        
        .regen-btn { background-color: #e74c3c; width: auto; font-size: 14px; padding: 8px 16px; margin-top: 10px; }

        /* ë¬¸ì œ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .question-card { border: 1px solid #e1e4e8; padding: 20px; margin-bottom: 20px; border-radius: 8px; background: #fff; position: relative; transition: all 0.3s ease; }
        .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; color: white; background: #34495e; margin-bottom: 10px; }
        .q-text { font-size: 1.1em; font-weight: bold; margin-bottom: 15px; }
        
        /* ë³´ê¸°(Options) ìŠ¤íƒ€ì¼ */
        .options-list label { display: block; padding: 12px; border: 1px solid #eee; border-radius: 6px; margin-bottom: 8px; cursor: pointer; font-weight: normal; transition: background 0.2s; }
        .options-list label:hover { background-color: #f8f9fa; }
        .options-list input[type="radio"] { margin-right: 10px; transform: scale(1.2); }

        /* ê²°ê³¼(ì±„ì ) ìŠ¤íƒ€ì¼ */
        .result-section { display: none; margin-top: 15px; padding-top: 15px; border-top: 2px dashed #eee; background-color: #fcfcfc; padding: 15px; border-radius: 6px; animation: fadeIn 0.5s; }
        .correct-card { border: 2px solid #2ecc71; background-color: #f0fff4; }
        .incorrect-card { border: 2px solid #e74c3c; background-color: #fff5f5; }
        
        .status-icon { float: right; font-size: 1.5em; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .loader { display: none; text-align: center; margin: 20px 0; }
    </style>
</head>
<body>

    <div id="scoreHeader" class="score-header">
        <span class="score-text">ğŸ“Š í˜„ì¬ ì ìˆ˜: <span id="currentScore">0</span> / <span id="totalCount">0</span></span>
        <button onclick="location.reload()" style="width: auto; padding: 8px 16px; font-size: 14px; background:#95a5a6;">ì²˜ìŒë¶€í„° ë‹¤ì‹œ</button>
    </div>

    <h1>ğŸ“ DocuQuiz </h1>

    <div class="card" id="setupCard">
        <div class="form-group">
            <label>ğŸ“‚ PDF íŒŒì¼ ì ˆëŒ€ ê²½ë¡œ</label>
            <input type="text" id="filePath" placeholder="ì˜ˆ: C:\Users\Name\project\sample.pdf">
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>ë¬¸í•­ ìˆ˜</label>
                <input type="number" id="qCount" value="3" min="1" max="10">
            </div>
            <div class="form-group">
                <label>ë‚œì´ë„</label>
                <select id="difficulty">
                    <option value="ì‰¬ì›€">ì‰¬ì›€</option>
                    <option value="ë³´í†µ" selected>ë³´í†µ</option>
                    <option value="ì–´ë ¤ì›€">ì–´ë ¤ì›€</option>
                </select>
            </div>
        </div>
        <button onclick="generateQuiz()" id="genBtn">ğŸš€ í€´ì¦ˆ ìƒì„± ì‹œì‘</button>
    </div>

    <div id="loader" class="loader">
        <p>ğŸ¤– AIê°€ ë¬¸ì„œë¥¼ ë¶„ì„í•˜ê³  ë¬¸ì œë¥¼ ì¶œì œ ì¤‘ì…ë‹ˆë‹¤...</p>
        <p>(PDF í¬ê¸°ì— ë”°ë¼ 10~30ì´ˆ ì •ë„ ì†Œìš”ë©ë‹ˆë‹¤)</p>
    </div>

    <div id="questionsContainer"></div>

    <div id="regenArea" class="card" style="display:none; border-left: 5px solid #e74c3c;">
        <h2>ğŸ”„ ì˜¤ë‹µ ì§‘ì¤‘ ê³µëµ (ì¬ì¶œì œ)</h2>
        <div id="regenContainer"></div>
    </div>

    <script>
        let currentQuizData = null;
        let solvedCount = 0;
        let correctScore = 0;

        // 1. í€´ì¦ˆ ìƒì„± ìš”ì²­
        async function generateQuiz() {
            const filePath = document.getElementById('filePath').value;
            if (!filePath) { alert('PDF íŒŒì¼ ê²½ë¡œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

            // UI ì´ˆê¸°í™”
            document.getElementById('genBtn').disabled = true;
            document.getElementById('loader').style.display = 'block';
            document.getElementById('setupCard').style.display = 'none'; // ì„¤ì •ì°½ ìˆ¨ê¹€
            document.getElementById('questionsContainer').innerHTML = '';
            
            // ì ìˆ˜ ì´ˆê¸°í™”
            solvedCount = 0;
            correctScore = 0;
            updateScoreBoard(0);

            try {
                const response = await fetch('http://localhost:3000/quiz/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        filePath: filePath,
                        options: {
                            questionCount: parseInt(document.getElementById('qCount').value),
                            types: ["ê°ê´€ì‹", "ì£¼ê´€ì‹", "OX"],
                            difficulty: document.getElementById('difficulty').value
                        }
                    })
                });

                if (!response.ok) throw new Error(`ì„œë²„ ì˜¤ë¥˜ (${response.status})`);

                const data = await response.json();
                currentQuizData = data;
                
                // ì ìˆ˜íŒ ì„¤ì •
                document.getElementById('totalCount').innerText = data.questions.length;
                document.getElementById('scoreHeader').style.display = 'flex';

                renderQuizInputs(data);

                document.getElementById('loader').style.display = 'none';
                
            } catch (error) {
                alert('ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
                document.getElementById('loader').style.display = 'none';
                document.getElementById('setupCard').style.display = 'block';
                document.getElementById('genBtn').disabled = false;
            }
        }

        // 2. ë¬¸ì œ í’€ì´ í™”ë©´ ë Œë”ë§
        function renderQuizInputs(data) {
            const container = document.getElementById('questionsContainer');
            
            data.questions.forEach((q, index) => {
                const qDiv = document.createElement('div');
                qDiv.className = 'question-card';
                qDiv.id = `card-${index}`;

                let inputHtml = '';

                // ê°ê´€ì‹ UI
                if (q.type === 'ê°ê´€ì‹' && q.options) {
                    inputHtml = `<div class="options-list">`;
                    q.options.forEach((opt) => {
                        inputHtml += `
                            <label>
                                <input type="radio" name="q_${index}" value="${opt}">
                                ${opt}
                            </label>`;
                    });
                    inputHtml += `</div>`;
                } 
                // OX í€´ì¦ˆ UI
                else if (q.type === 'OX') {
                    inputHtml = `<div class="options-list">
                        <label><input type="radio" name="q_${index}" value="O"> O</label>
                        <label><input type="radio" name="q_${index}" value="X"> X</label>
                    </div>`;
                }
                // ì£¼ê´€ì‹/ë‹¨ë‹µí˜• UI
                else {
                    inputHtml = `<input type="text" id="input_${index}" placeholder="ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”" style="font-size:1.1em;">`;
                }

                qDiv.innerHTML = `
                    <div class="status-icon" id="icon-${index}"></div>
                    <span class="badge">${q.type}</span> <span class="badge" style="background:#95a5a6">Page ${q.page}</span>
                    <div class="q-text">Q${index + 1}. ${q.question}</div>
                    ${inputHtml}
                    
                    <button class="check-btn" id="btn-${index}" onclick="checkAnswer(${index})">ì •ë‹µ í™•ì¸</button>

                    <div id="result-${index}" class="result-section">
                        <p><strong>ì •ë‹µ:</strong> <span style="color:#27ae60; font-weight:bold;">${q.answer}</span></p>
                        <p><strong>í•´ì„¤:</strong> ${q.explanation}</p>
                        <div id="regen-btn-${index}"></div>
                    </div>
                `;
                container.appendChild(qDiv);
            });
        }

        // 3. [ê°œë³„ ë¬¸ì œ] ì¦‰ì‹œ ì±„ì  ë¡œì§
        function checkAnswer(index) {
            const q = currentQuizData.questions[index];
            let userAnswer = '';

            // ì‚¬ìš©ì ì…ë ¥ê°’ ê°€ì ¸ì˜¤ê¸°
            if (q.type === 'ê°ê´€ì‹' || q.type === 'OX') {
                const checked = document.querySelector(`input[name="q_${index}"]:checked`);
                if (!checked) { alert('ë‹µì„ ì„ íƒí•´ì£¼ì„¸ìš”!'); return; }
                userAnswer = checked.value;
            } else {
                userAnswer = document.getElementById(`input_${index}`).value.trim();
                if (!userAnswer) { alert('ë‹µì„ ì…ë ¥í•´ì£¼ì„¸ìš”!'); return; }
            }

            // ì •ë‹µ ë¹„êµ (ê³µë°± ì œê±°, ì†Œë¬¸ì ë³€í™˜ í›„ ë¹„êµ)
            const isCorrect = userAnswer.replace(/\s+/g, '').toLowerCase() === q.answer.replace(/\s+/g, '').toLowerCase();

            // ì ìˆ˜ ì—…ë°ì´íŠ¸
            solvedCount++;
            if (isCorrect) correctScore++;
            updateScoreBoard(correctScore);

            // UI ì—…ë°ì´íŠ¸ (ì¹´ë“œ ìŠ¤íƒ€ì¼ ë³€ê²½)
            const card = document.getElementById(`card-${index}`);
            const resultDiv = document.getElementById(`result-${index}`);
            const btn = document.getElementById(`btn-${index}`);
            const icon = document.getElementById(`icon-${index}`);

            // ì…ë ¥ ë¹„í™œì„±í™” (ìˆ˜ì • ë°©ì§€)
            disableInput(index);
            btn.style.display = 'none'; // ë²„íŠ¼ ìˆ¨ê¹€
            resultDiv.style.display = 'block'; // ê²°ê³¼ì°½ í‘œì‹œ

            if (isCorrect) {
                card.classList.add('correct-card');
                icon.innerHTML = 'âœ…';
                resultDiv.insertAdjacentHTML('afterbegin', `<p style="color:#2ecc71; font-weight:bold;">ì •ë‹µì…ë‹ˆë‹¤! ğŸ‰</p>`);
            } else {
                card.classList.add('incorrect-card');
                icon.innerHTML = 'âŒ';
                resultDiv.insertAdjacentHTML('afterbegin', `<p style="color:#e74c3c; font-weight:bold;">ì•„ì‰½ë„¤ìš”. (ë‚´ ë‹µ: ${userAnswer})</p>`);
                
                // í‹€ë ¸ì„ ë•Œë§Œ ì¬ì¶œì œ ë²„íŠ¼ í‘œì‹œ
                const regenDiv = document.getElementById(`regen-btn-${index}`);
                regenDiv.innerHTML = `<button class="regen-btn" onclick="regenerateSingle(${index}, '${userAnswer}')">âš¡ ì´ ê°œë…ìœ¼ë¡œ ìƒˆ ë¬¸ì œ ë„ì „!</button>`;
            }
        }

        function disableInput(index) {
            const inputs = document.querySelectorAll(`input[name="q_${index}"], #input_${index}`);
            inputs.forEach(input => input.disabled = true);
        }

        function updateScoreBoard(score) {
            document.getElementById('currentScore').innerText = score;
        }

        // 4. ì˜¤ë‹µ ê¸°ë°˜ ì¬ì¶œì œ ìš”ì²­
        async function regenerateSingle(index, wrongAnswer) {
            const originalQ = currentQuizData.questions[index];
            
            // ë²„íŠ¼ ë¹„í™œì„±í™” (ì¤‘ë³µ í´ë¦­ ë°©ì§€)
            const btn = event.target;
            btn.disabled = true;
            btn.innerText = "ìƒì„± ì¤‘...";

            try {
                const response = await fetch('http://localhost:3000/quiz/regenerate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify([{
                        originalQuestion: originalQ,
                        userAnswer: wrongAnswer,
                        sourceContext: originalQ.source_context
                    }])
                });

                const data = await response.json();
                renderRegenResult(data);

            } catch (error) {
                alert('ì¬ì¶œì œ ì‹¤íŒ¨: ' + error);
            } finally {
                btn.innerText = "ìƒì„± ì™„ë£Œ";
            }
        }

        function renderRegenResult(data) {
            const container = document.getElementById('regenContainer');
            
            if (!data.questions || data.questions.length === 0) {
                alert("AIê°€ ìƒˆ ë¬¸ì œë¥¼ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                return;
            }

            data.questions.forEach((q) => {
                const qDiv = document.createElement('div');
                qDiv.className = 'question-card';
                qDiv.style.borderLeft = "5px solid #e74c3c";
                qDiv.style.backgroundColor = "#fff5f5";
                qDiv.innerHTML = `
                    <span class="badge" style="background:#e74c3c">ë³µìŠµ ë¬¸ì œ</span>
                    <div class="q-text">Q. ${q.question}</div>
                    <details>
                        <summary style="cursor:pointer; color:#e74c3c; font-weight:bold;">ì •ë‹µ ë° í•´ì„¤ ë³´ê¸°</summary>
                        <p style="margin-top:10px;"><strong>ì •ë‹µ:</strong> ${q.answer}</p>
                        <p><strong>í•´ì„¤:</strong> ${q.explanation}</p>
                    </details>
                `;
                container.appendChild(qDiv);
            });

            document.getElementById('regenArea').style.display = 'block';
            document.getElementById('regenArea').scrollIntoView({behavior: "smooth"});
        }
    </script>

</body>
</html>