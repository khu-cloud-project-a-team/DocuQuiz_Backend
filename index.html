<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DocuQuiz í†µí•© í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }

        h1,
        h2,
        h3 {
            color: #2c3e50;
        }

        .screen {
            display: none;
        }

        .active-screen {
            display: block;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .stats-container {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }

        .stat-box {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            flex: 1;
            margin: 0 10px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
        }

        .btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.2s;
        }

        .btn:hover {
            background-color: #2980b9;
        }

        .btn-secondary {
            background-color: #95a5a6;
        }

        .btn-secondary:hover {
            background-color: #7f8c8d;
        }

        .btn-success {
            background-color: #27ae60;
        }

        .btn-success:hover {
            background-color: #2ecc71;
        }

        .list-group {
            list-style: none;
            padding: 0;
        }

        .list-item {
            background: #fff;
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .question-card {
            background: #fff;
            border: 1px solid #e1e4e8;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            color: white;
            background: #34495e;
            margin-bottom: 10px;
        }

        .loader {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 9999;
            text-align: center;
            padding-top: 200px;
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
        }

        .weakness-box {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            white-space: pre-wrap;
        }
    </style>
</head>

<body>

    <div id="loader" class="loader">â³ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...</div>

    <!-- ë©”ì¸ í™”ë©´ -->
    <div id="mainScreen" class="screen active-screen">
        <h1>ğŸ“ DocuQuiz ëŒ€ì‹œë³´ë“œ</h1>

        <div class="stats-container">
            <div class="stat-box">
                <div>ì—…ë¡œë“œí•œ PDF</div>
                <div class="stat-value" id="statPdfCount">-</div>
            </div>
            <div class="stat-box">
                <div>ìƒì„±í•œ ë¬¸ì œì§‘</div>
                <div class="stat-value" id="statQuizCount">-</div>
            </div>
            <div class="stat-box">
                <div>í‰ê·  ì ìˆ˜</div>
                <div class="stat-value" id="statAvgScore">-</div>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ“‚ PDF íŒŒì¼ ì—…ë¡œë“œ</h2>
            <input type="file" id="pdfFile" accept=".pdf">
            <button class="btn" onclick="uploadFile()">ì—…ë¡œë“œ</button>
        </div>

        <div class="card">
            <h2>ğŸ“„ PDF ëª©ë¡</h2>
            <ul id="pdfList" class="list-group">
                <!-- PDF ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë¨ -->
            </ul>
        </div>

        <div class="card">
            <h2>âŒ ì˜¤ë‹µë…¸íŠ¸ ëª©ë¡</h2>
            <ul id="noteList" class="list-group">
                <!-- ì˜¤ë‹µë…¸íŠ¸ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë¨ -->
            </ul>
        </div>

        <div class="card">
            <h2>ğŸ“ ìƒì„±ëœ ë¬¸ì œì§‘ ëª©ë¡</h2>
            <ul id="quizList" class="list-group">
                <!-- ë¬¸ì œì§‘ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë¨ -->
            </ul>
        </div>
    </div>

    <!-- í€´ì¦ˆ ìƒì„± í™”ë©´ -->
    <div id="quizGenScreen" class="screen">
        <h1>ğŸ“ í€´ì¦ˆ ìƒì„± ì„¤ì •</h1>
        <div class="card">
            <h3>ì„ íƒëœ íŒŒì¼: <span id="selectedFileName"></span></h3>
            <input type="hidden" id="selectedFilePath">

            <div style="margin: 15px 0;">
                <label>ë¬¸í•­ ìˆ˜: <input type="number" id="qCount" value="3" min="1" max="10"></label>
            </div>

            <div style="margin: 15px 0;">
                <label>ë‚œì´ë„:
                    <select id="difficulty">
                        <option value="ì‰¬ì›€">ì‰¬ì›€</option>
                        <option value="ë³´í†µ" selected>ë³´í†µ</option>
                        <option value="ì–´ë ¤ì›€">ì–´ë ¤ì›€</option>
                    </select>
                </label>
            </div>

            <div style="margin: 15px 0;">
                <label>ìœ í˜•:
                    <label><input type="checkbox" class="qType" value="ê°ê´€ì‹" checked> ê°ê´€ì‹</label>
                    <label><input type="checkbox" class="qType" value="OX" checked> OX</label>
                    <label><input type="checkbox" class="qType" value="ì£¼ê´€ì‹"> ì£¼ê´€ì‹</label>
                    <label><input type="checkbox" class="qType" value="ë¹ˆì¹¸"> ë¹ˆì¹¸</label>
                </label>
            </div>

            <button class="btn" onclick="generateQuiz()">í€´ì¦ˆ ìƒì„±í•˜ê¸°</button>
            <button class="btn btn-secondary" onclick="showScreen('mainScreen')">ì·¨ì†Œ</button>
        </div>
    </div>

    <!-- í€´ì¦ˆ í’€ì´ í™”ë©´ -->
    <div id="quizSolveScreen" class="screen">
        <h1 id="quizTitleDisplay">ğŸ“ í€´ì¦ˆ í’€ê¸°</h1>
        <div id="weaknessDisplay" class="weakness-box" style="display:none;"></div>

        <div id="questionsContainer"></div>

        <button class="btn btn-success" onclick="submitQuiz()" style="width: 100%; margin-top: 20px;">ê²°ê³¼ ì œì¶œ</button>
        <button class="btn btn-secondary" onclick="showScreen('mainScreen')"
            style="width: 100%; margin-top: 10px;">ë‚˜ê°€ê¸°</button>
    </div>

    <!-- ê²°ê³¼ í™”ë©´ -->
    <div id="resultScreen" class="screen">
        <h1>ğŸ‰ í€´ì¦ˆ ê²°ê³¼</h1>
        <div class="card" style="text-align: center;">
            <h2 id="resultScore">0ì </h2>
            <p>ë§ì€ ê°œìˆ˜: <span id="resultCorrect">0</span> / <span id="resultTotal">0</span></p>
            <div id="pdfLinkContainer" style="margin: 20px 0;">
                <!-- PDF ë§í¬ -->
            </div>

            <button class="btn" id="regenBtn" onclick="regenerateFromNote()" style="display:none;">ì˜¤ë‹µ ê¸°ë°˜ ë¬¸ì œ ì¬ìƒì„±</button>
            <button class="btn btn-secondary" onclick="showScreen('mainScreen')">ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>
    </div>

    <script>
        // ì „ì—­ ìƒíƒœ
        let currentQuizId = null;
        let currentQuestions = [];
        let userAnswers = {};
        let currentWrongAnswerNoteId = null;

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            loadPdfList();
            loadNoteList();
            loadQuizList();
        });

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active-screen'));
            document.getElementById(screenId).classList.add('active-screen');

            if (screenId === 'mainScreen') {
                loadStats();
                loadPdfList();
                loadNoteList();
                loadQuizList();
            }
        }

        function setLoading(isLoading) {
            document.getElementById('loader').style.display = isLoading ? 'block' : 'none';
        }

        // --- API í˜¸ì¶œ í•¨ìˆ˜ë“¤ ---

        async function loadStats() {
            try {
                const res = await fetch('http://localhost:3000/quiz/stats');
                const data = await res.json();
                document.getElementById('statPdfCount').innerText = data.pdfCount;
                document.getElementById('statQuizCount').innerText = data.quizCount;
                document.getElementById('statAvgScore').innerText = data.avgScore + 'ì ';
            } catch (e) {
                console.error('í†µê³„ ë¡œë“œ ì‹¤íŒ¨', e);
            }
        }

        async function loadPdfList() {
            try {
                const res = await fetch('http://localhost:3000/file');
                const files = await res.json();
                const list = document.getElementById('pdfList');
                list.innerHTML = '';
                files.forEach(file => {
                    const li = document.createElement('li');
                    li.className = 'list-item';
                    li.innerHTML = `
                        <span>ğŸ“„ ${file.originalName}</span>
                        <button class="btn" onclick="openQuizGen('${file.s3Url}', '${file.originalName}')">ë¬¸ì œ ì¶œì œ</button>
                    `;
                    list.appendChild(li);
                });
            } catch (e) {
                console.error('íŒŒì¼ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨', e);
            }
        }

        async function loadNoteList() {
            try {
                const res = await fetch('http://localhost:3000/quiz/wrong-answer-notes');
                const notes = await res.json();
                const list = document.getElementById('noteList');
                list.innerHTML = '';
                notes.forEach(note => {
                    const li = document.createElement('li');
                    li.className = 'list-item';
                    li.innerHTML = `
                        <span>âŒ ${note.title} (${new Date(note.createdAt).toLocaleDateString()})</span>
                        <button class="btn" onclick="regenerateFromNoteId('${note.id}')">ë³µìŠµ í€´ì¦ˆ ìƒì„±</button>
                    `;
                    list.appendChild(li);
                });
            } catch (e) {
                console.error('ì˜¤ë‹µë…¸íŠ¸ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨', e);
            }
        }

        async function loadQuizList() {
            try {
                const res = await fetch('http://localhost:3000/quiz');
                const quizzes = await res.json();
                const list = document.getElementById('quizList');
                list.innerHTML = '';
                quizzes.forEach(quiz => {
                    const li = document.createElement('li');
                    li.className = 'list-item';
                    li.innerHTML = `
                        <span>ğŸ“ ${quiz.title} (${new Date(quiz.createdAt).toLocaleDateString()}) - ${quiz.questionCount}ë¬¸ì œ</span>
                        <button class="btn" onclick="fetchAndStartQuiz('${quiz.id}')">í’€ê¸°</button>
                    `;
                    list.appendChild(li);
                });
            } catch (e) {
                console.error('ë¬¸ì œì§‘ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨', e);
            }
        }

        async function uploadFile() {
            const fileInput = document.getElementById('pdfFile');
            if (!fileInput.files[0]) return alert('íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”');

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            setLoading(true);
            try {
                const res = await fetch('http://localhost:3000/file/upload', { method: 'POST', body: formData });
                if (res.ok) {
                    alert('ì—…ë¡œë“œ ì„±ê³µ');
                    loadPdfList();
                    loadStats();
                    fileInput.value = '';
                } else {
                    alert('ì—…ë¡œë“œ ì‹¤íŒ¨');
                }
            } catch (e) {
                alert('ì—ëŸ¬: ' + e.message);
            } finally {
                setLoading(false);
            }
        }

        function openQuizGen(filePath, fileName) {
            document.getElementById('selectedFileName').innerText = fileName;
            document.getElementById('selectedFilePath').value = filePath;
            showScreen('quizGenScreen');
        }

        async function generateQuiz() {
            const filePath = document.getElementById('selectedFilePath').value;
            const qCount = document.getElementById('qCount').value;
            const difficulty = document.getElementById('difficulty').value;
            const types = Array.from(document.querySelectorAll('.qType:checked')).map(cb => cb.value);

            if (types.length === 0) return alert('ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”');

            setLoading(true);
            try {
                const res = await fetch('http://localhost:3000/quiz/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        filePath,
                        options: { questionCount: parseInt(qCount), types, difficulty }
                    })
                });
                const data = await res.json();

                if (data.id) {
                    startQuiz(data);
                } else {
                    alert('í€´ì¦ˆ ìƒì„± ì‹¤íŒ¨');
                }
            } catch (e) {
                alert('ì—ëŸ¬: ' + e.message);
            } finally {
                setLoading(false);
            }
        }

        function startQuiz(quizData) {
            currentQuizId = quizData.id;
            currentQuestions = quizData.questions;
            userAnswers = {};

            document.getElementById('quizTitleDisplay').innerText = `ğŸ“ ${quizData.title}`;

            // ì·¨ì•½ì  ë¶„ì„ í‘œì‹œ (ì¬ìƒì„± í€´ì¦ˆì¸ ê²½ìš°)
            const weaknessDiv = document.getElementById('weaknessDisplay');
            if (quizData.weaknessAnalysis) {
                weaknessDiv.style.display = 'block';
                weaknessDiv.innerText = `ğŸ’¡ ì·¨ì•½ì  ë¶„ì„:\n${quizData.weaknessAnalysis}`;
            } else {
                weaknessDiv.style.display = 'none';
            }

            renderQuestions(currentQuestions);
            showScreen('quizSolveScreen');
        }

        async function fetchAndStartQuiz(quizId) {
            setLoading(true);
            try {
                const res = await fetch(`http://localhost:3000/quiz/${quizId}`);
                const quizData = await res.json();
                startQuiz(quizData);
            } catch (e) {
                alert('í€´ì¦ˆ ë¡œë“œ ì‹¤íŒ¨: ' + e.message);
            } finally {
                setLoading(false);
            }
        }

        function renderQuestions(questions) {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';

            questions.forEach((q, idx) => {
                const div = document.createElement('div');
                div.className = 'question-card';
                div.id = `card-${q.id}`;

                let inputHtml = '';
                if (q.options && q.options.length > 0) {
                    q.options.forEach(opt => {
                        inputHtml += `<label style="display:block; margin: 5px 0;"><input type="radio" name="q_${q.id}" value="${opt}"> ${opt}</label>`;
                    });
                } else if (q.type === 'OX') {
                    inputHtml += `<label><input type="radio" name="q_${q.id}" value="O"> O</label> `;
                    inputHtml += `<label><input type="radio" name="q_${q.id}" value="X"> X</label>`;
                } else {
                    inputHtml += `<input type="text" id="input_${q.id}" style="width:100%; padding:8px;" placeholder="ë‹µì„ ì…ë ¥í•˜ì„¸ìš”">`;
                }

                div.innerHTML = `
                    <span class="badge">${q.type}</span>
                    <h3>Q${idx + 1}. ${q.question}</h3>
                    <div id="input-area-${q.id}">${inputHtml}</div>
                    <button class="btn" id="btn-check-${q.id}" onclick="checkAnswer('${q.id}')" style="margin-top:10px; padding: 5px 10px;">ì •ë‹µ í™•ì¸</button>
                    <div id="feedback-${q.id}" style="display:none; margin-top:15px; padding:10px; border-radius:5px;"></div>
                `;
                container.appendChild(div);
            });
        }

        function checkAnswer(qId) {
            const q = currentQuestions.find(item => item.id === qId);
            let val = null;

            if (q.type === 'ê°ê´€ì‹' || q.type === 'OX') {
                const checked = document.querySelector(`input[name="q_${qId}"]:checked`);
                if (checked) val = checked.value;
            } else {
                const input = document.getElementById(`input_${qId}`);
                if (input) val = input.value;
            }

            if (!val) return alert('ë‹µì„ ì…ë ¥/ì„ íƒí•´ì£¼ì„¸ìš”');

            // ì •ë‹µ í™•ì¸ ë¡œì§
            const isCorrect = val.trim().toLowerCase() === q.answer.trim().toLowerCase();

            // UI ì—…ë°ì´íŠ¸
            const feedbackDiv = document.getElementById(`feedback-${qId}`);
            feedbackDiv.style.display = 'block';

            if (isCorrect) {
                feedbackDiv.style.backgroundColor = '#d4edda';
                feedbackDiv.style.color = '#155724';
                feedbackDiv.innerHTML = `<strong>âœ… ì •ë‹µì…ë‹ˆë‹¤!</strong>`;
            } else {
                feedbackDiv.style.backgroundColor = '#f8d7da';
                feedbackDiv.style.color = '#721c24';
                feedbackDiv.innerHTML = `<strong>âŒ ì˜¤ë‹µì…ë‹ˆë‹¤.</strong><br>ì •ë‹µ: ${q.answer}<br><br>ğŸ“ <strong>í•´ì„¤:</strong> ${q.explanation}`;
            }

            // ì…ë ¥ ë° ë²„íŠ¼ ë¹„í™œì„±í™” (ìˆ˜ì • ë¶ˆê°€)
            document.getElementById(`btn-check-${qId}`).disabled = true;
            document.getElementById(`btn-check-${qId}`).style.display = 'none';

            if (q.type === 'ê°ê´€ì‹' || q.type === 'OX') {
                document.querySelectorAll(`input[name="q_${qId}"]`).forEach(el => el.disabled = true);
            } else {
                document.getElementById(`input_${qId}`).disabled = true;
            }

            // ë‹µì•ˆ ì €ì¥
            userAnswers[qId] = val;
        }

        async function submitQuiz() {
            // í’€ì§€ ì•Šì€ ë¬¸ì œ í™•ì¸
            const unanswered = currentQuestions.filter(q => !userAnswers[q.id]);
            if (unanswered.length > 0) {
                alert(`ì•„ì§ í’€ì§€ ì•Šì€ ë¬¸ì œê°€ ${unanswered.length}ê°œ ìˆìŠµë‹ˆë‹¤. ëª¨ë“  ë¬¸ì œë¥¼ í’€ê³  ì •ë‹µ í™•ì¸ì„ í•´ì£¼ì„¸ìš”.`);
                return;
            }

            setLoading(true);
            try {
                const answersPayload = Object.keys(userAnswers).map(qId => ({
                    questionId: qId,
                    selectedAnswer: userAnswers[qId]
                }));

                const res = await fetch('http://localhost:3000/quiz/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ quizId: currentQuizId, answers: answersPayload })
                });
                const result = await res.json();

                // ê²°ê³¼ í™”ë©´ í‘œì‹œ
                document.getElementById('resultScore').innerText = `${result.score}ì `;
                document.getElementById('resultCorrect').innerText = result.correctQuestions;
                document.getElementById('resultTotal').innerText = result.totalQuestions;

                // ì˜¤ë‹µë…¸íŠ¸ ë²„íŠ¼ ì²˜ë¦¬
                const regenBtn = document.getElementById('regenBtn');
                if (result.wrongAnswerNoteId) {
                    currentWrongAnswerNoteId = result.wrongAnswerNoteId;
                    regenBtn.style.display = 'inline-block';
                    regenBtn.disabled = false; // ë²„íŠ¼ í™œì„±í™”
                    regenBtn.innerText = 'ì˜¤ë‹µ ê¸°ë°˜ ë¬¸ì œ ì¬ìƒì„±';
                } else {
                    currentWrongAnswerNoteId = null;
                    regenBtn.style.display = 'none';
                }

                showScreen('resultScreen');

            } catch (e) {
                alert('ì œì¶œ ì‹¤íŒ¨: ' + e.message);
            } finally {
                setLoading(false);
            }
        }

        async function regenerateFromNote() {
            if (!currentWrongAnswerNoteId) return;

            // ë²„íŠ¼ ë¹„í™œì„±í™” (ì¤‘ë³µ í´ë¦­ ë°©ì§€)
            const regenBtn = document.getElementById('regenBtn');
            regenBtn.disabled = true;
            regenBtn.innerText = 'ìƒì„± ì¤‘...';

            setLoading(true);
            try {
                const res = await fetch('http://localhost:3000/quiz/regenerate-from-note', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ noteId: currentWrongAnswerNoteId })
                });
                const data = await res.json();

                if (data.id) {
                    startQuiz(data);
                } else {
                    alert('ì¬ìƒì„± ì‹¤íŒ¨');
                    regenBtn.disabled = false;
                    regenBtn.innerText = 'ì˜¤ë‹µ ê¸°ë°˜ ë¬¸ì œ ì¬ìƒì„±';
                }
            } catch (e) {
                alert('ì—ëŸ¬: ' + e.message);
                regenBtn.disabled = false;
                regenBtn.innerText = 'ì˜¤ë‹µ ê¸°ë°˜ ë¬¸ì œ ì¬ìƒì„±';
            } finally {
                setLoading(false);
            }
        }

        async function regenerateFromNoteId(noteId) {
            setLoading(true);
            try {
                const res = await fetch('http://localhost:3000/quiz/regenerate-from-note', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ noteId })
                });
                const data = await res.json();

                if (data.id) {
                    startQuiz(data);
                } else {
                    alert('ì¬ìƒì„± ì‹¤íŒ¨');
                }
            } catch (e) {
                alert('ì—ëŸ¬: ' + e.message);
            } finally {
                setLoading(false);
            }
        }
    </script>
</body>

</html>