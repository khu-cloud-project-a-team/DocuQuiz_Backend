<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DocuQuiz Integrated Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }

        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #34495e;
        }

        input[type="file"],
        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
        }

        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background 0.2s;
            width: 100%;
            margin-top: 10px;
        }

        button:hover {
            background-color: #2980b9;
        }

        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }

        .question-card {
            border: 1px solid #e1e4e8;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            background: #fff;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            color: white;
            background: #34495e;
            margin-bottom: 10px;
        }

        .result-box {
            background: #e8f6f3;
            border: 2px solid #1abc9c;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin-top: 20px;
            display: none;
        }

        .loader {
            display: none;
            text-align: center;
            margin: 20px 0;
            font-weight: bold;
            color: #3498db;
        }
    </style>
</head>

<body>

    <h1>ğŸ“ DocuQuiz í†µí•© í…ŒìŠ¤íŠ¸</h1>

    <!-- 1. íŒŒì¼ ì—…ë¡œë“œ -->
    <div class="card" id="uploadCard">
        <h2>1. PDF ì—…ë¡œë“œ</h2>
        <div class="form-group">
            <input type="file" id="pdfFile" accept=".pdf">
        </div>
        <button onclick="uploadFile()" id="uploadBtn">íŒŒì¼ ì—…ë¡œë“œ</button>
    </div>

    <!-- 2. í€´ì¦ˆ ìƒì„± -->
    <div class="card" id="generateCard" style="display:none; opacity: 0.5; pointer-events: none;">
        <h2>2. í€´ì¦ˆ ìƒì„±</h2>
        <input type="hidden" id="uploadedFilePath">
        <div class="form-group">
            <label>ë¬¸í•­ ìˆ˜</label>
            <input type="number" id="qCount" value="3" min="1" max="10">
        </div>
        <div class="form-group">
            <label>ë‚œì´ë„</label>
            <select id="difficulty">
                <option value="ì‰¬ì›€">ì‰¬ì›€</option>
                <option value="ë³´í†µ" selected>ë³´í†µ</option>
                <option value="ì–´ë ¤ì›€">ì–´ë ¤ì›€</option>
            </select>
        </div>
        <div class="form-group">
            <label>ë¬¸ì œ ìœ í˜• (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥)</label>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <label><input type="checkbox" class="qType" value="ê°ê´€ì‹" checked> ê°ê´€ì‹</label>
                <label><input type="checkbox" class="qType" value="OX" checked> O/X</label>
                <label><input type="checkbox" class="qType" value="ì£¼ê´€ì‹"> ì£¼ê´€ì‹</label>
                <label><input type="checkbox" class="qType" value="ë¹ˆì¹¸"> ë¹ˆì¹¸</label>
            </div>
        </div>
        <button onclick="generateQuiz()" id="genBtn">í€´ì¦ˆ ìƒì„±í•˜ê¸°</button>
    </div>

    <div id="loader" class="loader">â³ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</div>

    <!-- 3. ë¬¸ì œ í’€ê¸° -->
    <div id="quizArea" style="display:none;">
        <div id="questionsContainer"></div>
        <button onclick="submitQuiz()" id="submitBtn" style="background-color: #27ae60; margin-top: 30px;">ê²°ê³¼ ì €ì¥
            ë° ìµœì¢… ì ìˆ˜ í™•ì¸</button>
    </div>

    <!-- 4. ê²°ê³¼ í™•ì¸ -->
    <div id="resultArea" class="result-box">
        <h2>ğŸ‰ ìµœì¢… ê²°ê³¼</h2>
        <p style="font-size: 1.5em; font-weight: bold;">ì ìˆ˜: <span id="scoreDisplay">0</span>ì </p>
        <p>ë§ì€ ê°œìˆ˜: <span id="correctDisplay">0</span> / <span id="totalDisplay">0</span></p>
    </div>

    <script>
        let currentQuizId = null;
        let currentQuestions = [];
        let userAnswers = {}; // Store answers as { questionId: answer }

        // 1. íŒŒì¼ ì—…ë¡œë“œ
        async function uploadFile() {
            const fileInput = document.getElementById('pdfFile');
            if (!fileInput.files[0]) { alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            setLoading(true);
            try {
                const response = await fetch('http://localhost:3000/file/upload', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (data.s3Url) {
                    document.getElementById('uploadedFilePath').value = data.s3Url;
                    alert('ì—…ë¡œë“œ ì„±ê³µ! í€´ì¦ˆ ìƒì„± ë‹¨ê³„ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤.');

                    const genCard = document.getElementById('generateCard');
                    genCard.style.display = 'block';
                    genCard.style.opacity = '1';
                    genCard.style.pointerEvents = 'auto';
                    document.getElementById('uploadCard').style.display = 'none';
                } else {
                    alert('ì—…ë¡œë“œ ì‹¤íŒ¨');
                }
            } catch (e) {
                alert('ì—ëŸ¬: ' + e.message);
            } finally {
                setLoading(false);
            }
        }

        // 2. í€´ì¦ˆ ìƒì„±
        async function generateQuiz() {
            const filePath = document.getElementById('uploadedFilePath').value;

            // ì„ íƒëœ ìœ í˜• ê°€ì ¸ì˜¤ê¸°
            const selectedTypes = Array.from(document.querySelectorAll('.qType:checked')).map(cb => cb.value);
            if (selectedTypes.length === 0) {
                alert('ìµœì†Œ í•œ ê°€ì§€ ì´ìƒì˜ ë¬¸ì œ ìœ í˜•ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            setLoading(true);
            try {
                const response = await fetch('http://localhost:3000/quiz/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        filePath: filePath,
                        options: {
                            questionCount: parseInt(document.getElementById('qCount').value),
                            types: selectedTypes,
                            difficulty: document.getElementById('difficulty').value
                        }
                    })
                });
                const data = await response.json();

                if (data.id) {
                    if (!data.questions || data.questions.length === 0) {
                        alert('í€´ì¦ˆ ìƒì„± ì‹¤íŒ¨: ìƒì„±ëœ ë¬¸í•­ì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                        return;
                    }
                    currentQuizId = data.id;
                    currentQuestions = data.questions;

                    // í€´ì¦ˆ ì œëª© í‘œì‹œ
                    const quizTitle = data.title || 'ìƒì„±ëœ í€´ì¦ˆ';
                    const quizArea = document.getElementById('quizArea');
                    let titleElement = document.getElementById('quizTitleDisplay');
                    if (!titleElement) {
                        titleElement = document.createElement('h2');
                        titleElement.id = 'quizTitleDisplay';
                        titleElement.style.color = '#2c3e50';
                        titleElement.style.textAlign = 'center';
                        quizArea.insertBefore(titleElement, quizArea.firstChild);
                    }
                    titleElement.innerText = `ğŸ“ ${quizTitle}`;

                    renderQuestions(data.questions);
                    document.getElementById('generateCard').style.display = 'none';
                    quizArea.style.display = 'block';
                } else {
                    alert('í€´ì¦ˆ ìƒì„± ì‹¤íŒ¨');
                }
            } catch (e) {
                alert('ì—ëŸ¬: ' + e.message);
            } finally {
                setLoading(false);
            }
        }

        // 3. ë¬¸ì œ ë Œë”ë§
        function renderQuestions(questions) {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';
            userAnswers = {}; // Reset answers

            questions.forEach((q, idx) => {
                const div = document.createElement('div');
                div.className = 'question-card';
                div.id = `q-card-${q.id}`;

                let optionsHtml = '';
                if (q.options && q.options.length > 0) {
                    q.options.forEach(opt => {
                        optionsHtml += `<label><input type="radio" name="q_${q.id}" value="${opt}"> ${opt}</label><br>`;
                    });
                } else if (q.type === 'OX') {
                    optionsHtml += `<label><input type="radio" name="q_${q.id}" value="O"> O</label><br>`;
                    optionsHtml += `<label><input type="radio" name="q_${q.id}" value="X"> X</label><br>`;
                } else {
                    optionsHtml = `<input type="text" id="input_${q.id}" placeholder="ë‹µì„ ì…ë ¥í•˜ì„¸ìš”" style="width:100%">`;
                }

                div.innerHTML = `
            <span class="badge">${q.type}</span>
            <h3>Q${idx + 1}. ${q.question}</h3>
            <div id="options-${q.id}">${optionsHtml}</div>
            
            <div style="margin-top: 15px;">
                <button onclick="checkSingleAnswer('${q.id}', ${idx})" id="btn-${q.id}" style="width: auto; padding: 8px 16px; font-size: 14px;">ì •ë‹µ í™•ì¸</button>
            </div>

            <div id="feedback-${q.id}" style="display:none; margin-top: 15px; padding: 15px; border-radius: 6px;">
                <p id="result-text-${q.id}" style="font-weight: bold; font-size: 1.1em;"></p>
                <p><strong>ì •ë‹µ:</strong> ${q.answer}</p>
                <p><strong>í•´ì„¤:</strong> ${q.explanation}</p>
            </div>
        `;
                container.appendChild(div);
            });
        }

        // ê°œë³„ ë¬¸ì œ ì±„ì 
        function checkSingleAnswer(questionId, index) {
            const q = currentQuestions[index];
            let val = null;

            if (q.type === 'ê°ê´€ì‹' || q.type === 'OX') {
                const checked = document.querySelector(`input[name="q_${questionId}"]:checked`);
                if (checked) val = checked.value;
            } else {
                const input = document.getElementById(`input_${questionId}`);
                if (input) val = input.value;
            }

            if (!val) {
                alert('ë‹µì„ ì…ë ¥/ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            // ì •ë‹µ ì €ì¥ (ë‚˜ì¤‘ì— ì¼ê´„ ì œì¶œìš©)
            userAnswers[questionId] = val;

            // ì±„ì  ë¡œì§ (ê°„ë‹¨í•œ ë¬¸ìì—´ ë¹„êµ)
            // ì‹¤ì œë¡œëŠ” ë°±ì—”ë“œ ë¡œì§ê³¼ ë™ì¼í•˜ê²Œ ì²˜ë¦¬í•´ì•¼ ì •í™•í•¨ (ê³µë°± ì œê±° ë“±)
            const isCorrect = val.trim().toLowerCase() === q.answer.trim().toLowerCase();

            // UI ì—…ë°ì´íŠ¸
            const feedbackDiv = document.getElementById(`feedback-${questionId}`);
            const resultText = document.getElementById(`result-text-${questionId}`);
            const card = document.getElementById(`q-card-${questionId}`);
            const btn = document.getElementById(`btn-${questionId}`);

            feedbackDiv.style.display = 'block';
            btn.style.display = 'none'; // ë²„íŠ¼ ìˆ¨ê¹€ (ì¤‘ë³µ ì±„ì  ë°©ì§€)

            // ì…ë ¥ ë¹„í™œì„±í™”
            if (q.type === 'ê°ê´€ì‹' || q.type === 'OX') {
                const radios = document.querySelectorAll(`input[name="q_${questionId}"]`);
                radios.forEach(r => r.disabled = true);
            } else {
                document.getElementById(`input_${questionId}`).disabled = true;
            }

            if (isCorrect) {
                resultText.innerText = "âœ… ì •ë‹µì…ë‹ˆë‹¤!";
                resultText.style.color = "#27ae60";
                feedbackDiv.style.backgroundColor = "#e8f8f5";
                feedbackDiv.style.border = "1px solid #2ecc71";
            } else {
                resultText.innerText = "âŒ ì˜¤ë‹µì…ë‹ˆë‹¤.";
                resultText.style.color = "#e74c3c";
                feedbackDiv.style.backgroundColor = "#fdedec";
                feedbackDiv.style.border = "1px solid #e74c3c";
            }
        }

        // 4. ìµœì¢… ì œì¶œ (DB ì €ì¥ìš©)
        async function submitQuiz() {
            // ì•„ì§ í’€ì§€ ì•Šì€ ë¬¸ì œê°€ ìˆëŠ”ì§€ í™•ì¸
            const answeredCount = Object.keys(userAnswers).length;
            if (answeredCount < currentQuestions.length) {
                if (!confirm(`ì´ ${currentQuestions.length}ë¬¸ì œ ì¤‘ ${answeredCount}ë¬¸ì œë§Œ í’€ì—ˆìŠµë‹ˆë‹¤. ê·¸ë˜ë„ ê²°ê³¼ë¥¼ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    return;
                }
            }

            const answersPayload = Object.keys(userAnswers).map(qId => ({
                questionId: qId,
                selectedAnswer: userAnswers[qId]
            }));

            setLoading(true);
            try {
                const response = await fetch('http://localhost:3000/quiz/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        quizId: currentQuizId,
                        answers: answersPayload
                    })
                });
                const result = await response.json();

                document.getElementById('quizArea').style.display = 'none';
                document.getElementById('resultArea').style.display = 'block';

                document.getElementById('scoreDisplay').innerText = result.score;
                document.getElementById('correctDisplay').innerText = result.correctQuestions;
                document.getElementById('totalDisplay').innerText = result.totalQuestions;

            } catch (e) {
                alert('ì œì¶œ ì‹¤íŒ¨: ' + e.message);
            } finally {
                setLoading(false);
            }
        }

        function setLoading(isLoading) {
            document.getElementById('loader').style.display = isLoading ? 'block' : 'none';
        }
    </script>
</body>

</html>